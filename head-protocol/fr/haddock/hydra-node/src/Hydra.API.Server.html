<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hydra.API.Server</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">seq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">newEmptyMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">takeMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TChan</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">newBroadcastTChanIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTChan</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">modifyTVar'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">newTVarIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html"><span class="hs-identifier">Hydra.API.APIServerLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIServerLog"><span class="hs-identifier">APIServerLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html"><span class="hs-identifier">Hydra.API.ClientInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier">ClientInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.HTTPServer.html"><span class="hs-identifier">Hydra.API.HTTPServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.HTTPServer.html#httpApp"><span class="hs-identifier">httpApp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html"><span class="hs-identifier">Hydra.API.Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier">Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier">mkProjection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html"><span class="hs-identifier">Hydra.API.ServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#HeadStatus"><span class="hs-identifier">HeadStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier">Idle</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier">ServerOutput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier">TimedServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier">projectHeadStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier">projectSnapshotUtxo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.WSServer.html"><span class="hs-identifier">Hydra.API.WSServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.WSServer.html#nextSequenceNumber"><span class="hs-identifier">nextSequenceNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.WSServer.html#wsApp"><span class="hs-identifier">wsApp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Cardano.Api</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ProtocolParameters</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.html"><span class="hs-identifier">Hydra.Chain</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier">Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier">IsChainState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.Direct.State.html"><span class="hs-identifier">Hydra.Chain.Direct.State</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Logging.html"><span class="hs-identifier">Hydra.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Network.html"><span class="hs-identifier">Hydra.Network</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IP</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PortNumber</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Party.html"><span class="hs-identifier">Hydra.Party</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier">Party</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Persistence.html"><span class="hs-identifier">Hydra.Persistence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.Warp</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="hs-identifier">runSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="hs-identifier">setBeforeMainLoop</span></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier">setHost</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="hs-identifier">setOnException</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="hs-identifier">setPort</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.WebSockets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">websocketsOr</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.WebSockets</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultConnectionOptions</span></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-- | Handle to provide a means for sending server outputs to clients.</span><span>
</span><span id="line-47"></span><span class="hs-keyword">newtype</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span id="local-6989586621680122897"><span class="annot"><a href="#local-6989586621680122897"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680122896"><span class="annot"><a href="#local-6989586621680122896"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="sendOutput"><span class="annot"><span class="annottext">forall tx (m :: * -&gt; *). Server tx m -&gt; ServerOutput tx -&gt; m ()
</span><a href="Hydra.API.Server.html#sendOutput"><span class="hs-identifier hs-var hs-var">sendOutput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122897"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680122896"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-comment">-- ^ Send some output to all connected clients.</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- | Callback for receiving client inputs.</span><span>
</span><span id="line-53"></span><span class="hs-keyword">type</span><span> </span><span id="ServerCallback"><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-var">ServerCallback</span></a></span></span><span> </span><span id="local-6989586621680122754"><span class="annot"><a href="#local-6989586621680122754"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680122753"><span class="annot"><a href="#local-6989586621680122753"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier hs-type">ClientInput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122754"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680122753"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | A type tying both receiving input and sending output into a /Component/.</span><span>
</span><span id="line-56"></span><span class="hs-keyword">type</span><span> </span><span id="ServerComponent"><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-var">ServerComponent</span></a></span></span><span> </span><span id="local-6989586621680122752"><span class="annot"><a href="#local-6989586621680122752"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680122751"><span class="annot"><a href="#local-6989586621680122751"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680122750"><span class="annot"><a href="#local-6989586621680122750"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-type">ServerCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122752"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122751"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122752"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122751"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680122751"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122750"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680122751"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122750"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="annot"><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-type">withAPIServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680122891"><span class="annot"><a href="#local-6989586621680122891"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier hs-type">IsChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122891"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier hs-type">Party</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122891"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122891"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ProtocolParameters</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-type">ServerComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680122891"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span id="withAPIServer"><span class="annot"><span class="annottext">withAPIServer :: forall tx.
IsChainState tx =&gt;
IP
-&gt; PortNumber
-&gt; Party
-&gt; PersistenceIncremental (TimedServerOutput tx) IO
-&gt; Tracer IO APIServerLog
-&gt; Chain tx IO
-&gt; ProtocolParameters
-&gt; ServerComponent tx IO ()
</span><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-var hs-var">withAPIServer</span></a></span></span><span> </span><span id="local-6989586621680122685"><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680122685"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621680122684"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680122684"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680122683"><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680122683"><span class="hs-identifier hs-var">party</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span class="hs-special">{</span><span id="local-6989586621680122681"><span class="annot"><span class="annottext">FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
loadAll :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; FromJSON a =&gt; m [a]
loadAll :: FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
</span><a href="Hydra.Persistence.html#loadAll"><span class="hs-identifier hs-var hs-var">loadAll</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680122679"><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
append :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; ToJSON a =&gt; a -&gt; m ()
append :: ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
</span><a href="Hydra.Persistence.html#append"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680122677"><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680122677"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680122676"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680122676"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621680122675"><span class="annot"><span class="annottext">ProtocolParameters
</span><a href="#local-6989586621680122675"><span class="hs-identifier hs-var">pparams</span></a></span></span><span> </span><span id="local-6989586621680122674"><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680122674"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621680122673"><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680122673"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO ()
</span><a href="#local-6989586621680122671"><span class="hs-identifier hs-var">onIOException</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>    </span><span id="local-6989586621680122670"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680122670"><span class="hs-identifier hs-var">responseChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. IO (TChan a)
</span><span class="hs-identifier hs-var">newBroadcastTChanIO</span></span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621680122669"><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680122669"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
</span><a href="#local-6989586621680122681"><span class="hs-identifier hs-var">loadAll</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- Intialize our read model from stored events</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621680122668"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680122668"><span class="hs-identifier hs-var">headStatusP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">HeadStatus
</span><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680122669"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall tx. HeadStatus -&gt; ServerOutput tx -&gt; HeadStatus
</span><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier hs-var">projectHeadStatus</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621680122665"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680122665"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680122669"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall tx.
Maybe (UTxOType tx) -&gt; ServerOutput tx -&gt; Maybe (UTxOType tx)
</span><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier hs-var">projectSnapshotUtxo</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- NOTE: we need to reverse the list because we store history in a reversed</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- list in memory but in order on disk</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621680122664"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122664"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; IO (TVar a)
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680122669"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680122662"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680122662"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680122661"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680122661"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var">setupServerNotification</span></a></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680122659"><span class="annot"><span class="annottext">serverSettings :: Settings
</span><a href="#local-6989586621680122659"><span class="hs-identifier hs-var hs-var">serverSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier hs-var">defaultSettings</span></span><span>
</span><span id="line-85"></span><span>            </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">HostPreference -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setHost</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. IsString a =&gt; String -&gt; a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromString</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680122685"><span class="hs-identifier hs-var">host</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Port -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setPort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680122684"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>            </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Request -&gt; SomeException -&gt; IO ()) -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setOnException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe Request
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680122656"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680122656"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680122677"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIConnectionError"><span class="hs-identifier hs-type">APIConnectionError</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">reason :: String
</span><a href="Hydra.API.APIServerLog.html#reason"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680122656"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>            </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setBeforeMainLoop</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680122662"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680122677"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber -&gt; APIServerLog
</span><a href="Hydra.API.APIServerLog.html#APIServerStarted"><span class="hs-identifier hs-var">APIServerStarted</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680122684"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>          </span><span class="annot"><span class="annottext">Settings -&gt; Application -&gt; IO ()
</span><span class="hs-identifier hs-var">runSettings</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621680122659"><span class="hs-identifier hs-var">serverSettings</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-93"></span><span>            </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; ServerApp -&gt; Application -&gt; Application
</span><span class="hs-identifier hs-var">websocketsOr</span></span><span>
</span><span id="line-94"></span><span>              </span><span class="annot"><span class="annottext">ConnectionOptions
</span><span class="hs-identifier hs-var">defaultConnectionOptions</span></span><span>
</span><span id="line-95"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx.
IsChainState tx =&gt;
Party
-&gt; Tracer IO APIServerLog
-&gt; TVar [TimedServerOutput tx]
-&gt; (ClientInput tx -&gt; IO ())
-&gt; Projection STM (ServerOutput tx) HeadStatus
-&gt; Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; TChan (TimedServerOutput tx)
-&gt; ServerApp
</span><a href="Hydra.API.WSServer.html#wsApp"><span class="hs-identifier hs-var">wsApp</span></a></span><span> </span><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680122683"><span class="hs-identifier hs-var">party</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680122677"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122664"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680122674"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680122668"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680122665"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680122670"><span class="hs-identifier hs-var">responseChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx.
Tracer IO APIServerLog
-&gt; Chain tx IO -&gt; ProtocolParameters -&gt; Application
</span><a href="Hydra.API.HTTPServer.html#httpApp"><span class="hs-identifier hs-var">httpApp</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680122677"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680122676"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolParameters
</span><a href="#local-6989586621680122675"><span class="hs-identifier hs-var">pparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>          </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680122661"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span><span>
</span><span id="line-100"></span><span>          </span><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680122673"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-101"></span><span>            </span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>
</span><span id="line-102"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sendOutput :: ServerOutput tx -&gt; IO ()
</span><a href="Hydra.API.Server.html#sendOutput"><span class="hs-identifier hs-var">sendOutput</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680122651"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680122651"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>                  </span><span id="local-6989586621680122650"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122650"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680122649"><span class="hs-identifier hs-var">appendToHistory</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122664"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680122651"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-104"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>                    </span><span class="annot"><span class="annottext">forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#update"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680122668"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680122651"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-106"></span><span>                    </span><span class="annot"><span class="annottext">forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#update"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680122665"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680122651"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-107"></span><span>                    </span><span class="annot"><span class="annottext">forall a. TChan a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680122670"><span class="hs-identifier hs-var">responseChannel</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122650"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-108"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-111"></span><span>  </span><span id="local-6989586621680122649"><span class="annot"><span class="annottext">appendToHistory :: TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680122649"><span class="hs-identifier hs-var hs-var">appendToHistory</span></a></span></span><span> </span><span id="local-6989586621680122646"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122646"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span id="local-6989586621680122645"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680122645"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>    </span><span id="local-6989586621680122644"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680122644"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621680122642"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122642"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>      </span><span id="local-6989586621680122641"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680122641"><span class="hs-identifier hs-var">seq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.WSServer.html#nextSequenceNumber"><span class="hs-identifier hs-var">nextSequenceNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122646"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680122640"><span class="annot"><span class="annottext">timedOutput :: TimedServerOutput tx
</span><a href="#local-6989586621680122640"><span class="hs-identifier hs-var hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ServerOutput tx
output :: ServerOutput tx
output :: ServerOutput tx
</span><a href="#local-6989586621680122645"><span class="hs-identifier hs-var hs-var">output</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
time :: UTCTime
time :: UTCTime
</span><a href="Hydra.API.ServerOutput.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
seq :: Natural
seq :: Natural
</span><a href="Hydra.API.ServerOutput.html#seq"><span class="hs-identifier hs-var hs-var">seq</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680122646"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122640"><span class="hs-identifier hs-var">timedOutput</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122640"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
</span><a href="#local-6989586621680122679"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122642"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680122642"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621680122671"><span class="annot"><span class="annottext">onIOException :: IOException -&gt; IO ()
</span><a href="#local-6989586621680122671"><span class="hs-identifier hs-var hs-var">onIOException</span></a></span></span><span> </span><span id="local-6989586621680122636"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680122636"><span class="hs-identifier hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">IOException
ioException :: IOException
ioException :: IOException
</span><a href="Hydra.API.Server.html#ioException"><span class="hs-identifier hs-var hs-var">ioException</span></a></span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IP
host :: IP
host :: IP
</span><a href="Hydra.API.Server.html#host"><span class="hs-identifier hs-var hs-var">host</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PortNumber
port :: PortNumber
port :: PortNumber
</span><a href="Hydra.API.Server.html#port"><span class="hs-identifier hs-var hs-var">port</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | An 'IOException' with more 'IP' and 'PortNumber' added as context.</span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ioException"><span class="annot"><span class="annottext">RunServerException -&gt; IOException
</span><a href="Hydra.API.Server.html#ioException"><span class="hs-identifier hs-var hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">IOException</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="host"><span class="annot"><span class="annottext">RunServerException -&gt; IP
</span><a href="Hydra.API.Server.html#host"><span class="hs-identifier hs-var hs-var">host</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="port"><span class="annot"><span class="annottext">RunServerException -&gt; PortNumber
</span><a href="Hydra.API.Server.html#port"><span class="hs-identifier hs-var hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680122618"><span id="local-6989586621680122620"><span id="local-6989586621680122629"><span class="annot"><span class="annottext">Port -&gt; RunServerException -&gt; ShowS
[RunServerException] -&gt; ShowS
RunServerException -&gt; String
forall a.
(Port -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RunServerException] -&gt; ShowS
$cshowList :: [RunServerException] -&gt; ShowS
show :: RunServerException -&gt; String
$cshow :: RunServerException -&gt; String
showsPrec :: Port -&gt; RunServerException -&gt; ShowS
$cshowsPrec :: Port -&gt; RunServerException -&gt; ShowS
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680122607"><span id="local-6989586621680122609"><span id="local-6989586621680122611"><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span></span></span></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-keyword">type</span><span> </span><span id="NotifyServerRunning"><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-var">NotifyServerRunning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-keyword">type</span><span> </span><span id="WaitForServer"><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-var">WaitForServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | Setup notification and waiter to ensure that something only runs after the</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- server is actually listening.</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-type">setupServerNotification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-type">NotifyServerRunning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-type">WaitForServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span id="setupServerNotification"><span class="annot"><span class="annottext">setupServerNotification :: IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var hs-var">setupServerNotification</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621680122603"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680122603"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. IO (MVar a)
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680122603"><span class="hs-identifier hs-var">mv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; IO a
</span><a href="../file:///nix/store/q054vsi5sfzqlmqglzmmfpa98y36ixhz-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680122603"><span class="hs-identifier hs-var">mv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span></pre></body></html>