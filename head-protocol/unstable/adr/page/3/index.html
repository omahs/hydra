<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Architectural Decision Records | Hydra: Head Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://input-output-hk.github.io/head-protocol/unstable/adr/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Architectural Decision Records | Hydra: Head Protocol"><meta data-rh="true" name="description" content="Lightweight technical documentation for the Hydra node software."><meta data-rh="true" property="og:description" content="Lightweight technical documentation for the Hydra node software."><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/head-protocol/unstable/img/hydra.png"><link data-rh="true" rel="canonical" href="https://input-output-hk.github.io/head-protocol/unstable/adr/page/3"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/adr/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/fr/adr/page/3" hreflang="fr"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/ja/adr/page/3" hreflang="ja"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/es/adr/page/3" hreflang="es"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/adr/page/3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YZTAF8IOVB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/head-protocol/unstable/adr/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/unstable/adr/atom.xml" title="Hydra: Head Protocol Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Hydra: Head Protocol" href="/head-protocol/unstable/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/head-protocol/unstable/monthly/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/unstable/monthly/atom.xml" title="Hydra: Head Protocol Atom Feed">







<script src="https://plausible.io/js/script.js" defer="defer" data-domain="hydra.family"></script><link rel="stylesheet" href="/head-protocol/unstable/assets/css/styles.e2304069.css">
<link rel="preload" href="/head-protocol/unstable/assets/js/runtime~main.9aa57279.js" as="script">
<link rel="preload" href="/head-protocol/unstable/assets/js/main.c6fe520e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/head-protocol/unstable/"><div class="navbar__logo"><img src="/head-protocol/unstable/img/hydra.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--light_HNdA"><img src="/head-protocol/unstable/img/hydra-white.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Hydra: Head Protocol</b></a><a class="navbar__item navbar__link" href="/head-protocol/unstable/docs/getting-started">User Manual</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/api-reference">API Reference</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/core-concepts">Core Concepts</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/benchmarks">Benchmarks</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/topologies">Topologies</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/use-cases">Use Cases</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/input-output-hk/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/head-protocol/unstable/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/head-protocol/unstable/fr/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Français</a></li><li><a href="/head-protocol/unstable/ja/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li><li><a href="/head-protocol/unstable/es/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="es">Español</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Architectural Decision Records</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/1">1. Record Architecture Decisions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/2">2. Reactive Core
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/3">3. Asynchronous Duplex Client API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/4">4. Use Handle to model Effects
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/5">5. Use io-classes
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/6">6. Network Broadcasts all messages
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/7">7. Use with-pattern based component interfaces
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/8">8. Custom Prelude
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/9">9. Simplify Logging
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/10">10. Use Direct Connection to `cardano-node`
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/11">11. Use cardano-api
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/12">12. Top-down Test-driven Design
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/13">13. Plutus Contracts Testing Strategy
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/14">14. Token usage in Hydra Scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/15">15. Configuration Through an Admin API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/16">16. Keep Rejected ADRs
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/17">17. Use UDP protocol for Hydra networking
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/18">18. Single state in Hydra.Node.
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/19">19. Use of reference scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/20">20. Handling time
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/22">22. Test High-level Properties using Model-Based Testing
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/23">23. Local chain state in chain layer
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/24">24. Persist state changes incrementally
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/25">25. Event-sourced, resource-based API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/27">27. Network failures model
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/adr/26">26. Stateless transaction observaion &amp; construction
</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-05T00:00:00.000Z" itemprop="datePublished">December 5, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ch1bo" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ch1bo.png" alt="Sebastian Nagel"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ch1bo" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sebastian Nagel</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineering Lead</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pgrange.png" alt="Pascal Grange"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Pascal Grange</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ffakenz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ffakenz.png" alt="Franco Testagrossa"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ffakenz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Franco Testagrossa</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/v0d1ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/v0d1ch.png" alt="Sasha Bogicevic"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/v0d1ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sasha Bogicevic</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Proposed</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><p>The HydraHeadV1 formal specification contains a <em>bounded confirmation window</em>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Deadline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T_max &lt;= T_min + L // Bounded confirmation window</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DL’ = T_max + L    // The latest possible deadline is 2*L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>with <code>T_min</code> and <code>T_max</code> being the tx validity bounds and <code>L</code> being the
contestation period.</p><ul><li>This is to avoid attacks with specified upper validity bound being too far
in the future and denial of service the head with this (e.g. 10 years).</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="current-state-of-things">Current state of things:<a href="#current-state-of-things" class="hash-link" aria-label="Direct link to Current state of things:" title="Direct link to Current state of things:">​</a></h4><ul><li><p>The contestation period and upper tx validity is used for computing the
contestation deadline.</p></li><li><p>There is a <code>closeGraceTime</code> currently hard-coded (to <code>100</code> slots) to set some
upper bound on the <code>closeTx</code>. This was also required so far to compute the
contestation deadline.</p></li><li><p>Different networks (chains) have different slot lenghts, e.g. the preview
network has a slot every <code>1s</code>, while our local devnets use <code>0.1s</code>. This means
hardcoded values like <code>closeGraceTime</code> need to be <em>in sync</em> with the
underlying network.</p></li><li><p>The <code>contestationPeriod</code> can be configured by users via the <code>Init</code> client
input. For example, the hydra-cluster test suite uses a hardcoded <code>cperiod</code> on
the client side.</p></li><li><p>Default value for <code>T_Min</code> is negative infinity.</p></li><li><p>Lower tx validity being in the future does not pose a problem since other
participant is able to close a head.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-we-want-to-achieve">What we want to achieve:<a href="#what-we-want-to-achieve" class="hash-link" aria-label="Direct link to What we want to achieve:" title="Direct link to What we want to achieve:">​</a></h4><ul class="contains-task-list containsTaskList_mC6p"><li><p>We want to enforce topmost formula in this file in our code on-chain.</p></li><li><p>Introduce <code>maxGraceTime</code> expressed in seconds in place of <code>closeGraceTime</code> and adjust to
appropriate value.</p></li><li><p>The contestation period is to be used to create bounded close transaction
(together with <code>maxGraceTime</code>). Before it was only used for computing the
contestation deadline.</p></li><li class="task-list-item"><p><input type="checkbox" checked="" disabled=""> <!-- -->If contestation period is higher than <code>maxGraceTime</code> we will pick the
latter. We still need <code>maxGraceTime</code> since if <code>contestationPeriod</code> is low for
the current network our txs reach the upper bound fast and become invalid.
That is why we set the upper tx bound to be minimum between
<code>contestationPeriod</code> and <code>maxGraceTime</code> so that txs have high enough upper
bound.</p></li><li><p>Make sure all head participants use the same value for <code>contestationPeriod</code>.</p></li><li><p>Attack vector has a corresponding mutation test.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li><p>Use the specification formula on-chain.</p></li><li><p>Configure the contestation period (number of seconds) on the <code>hydra-node</code>,
e.g. via a <code>--contestation-period</code> command line option.</p></li><li><p>Lower tx bound should be the last known slot as reported by the
<code>cardano-node</code>.</p></li><li><p>Upper tx bound is the current time + minimum between <code>contestationPeriod</code> and
<code>maxGraceTime</code>.</p></li><li><p>When submitting the <code>InitTx</code> make sure to use <code>--contestation-period</code> value
from our node&#x27;s flag.</p></li><li><p>If other nodes observe <code>OnInitTx</code> and the <code>contestationPeriod</code> value does not
match with their <code>--contestation-period</code> setting - ignore <code>InitTx</code>.</p></li><li><p>Rename <code>closeGraceTime</code> to <code>maxGraceTime</code> since we are using it also for upper
bound of a contest tx.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li><p>Not any positive number of seconds is a valid contestation period any more!</p></li><li><p>Upper tx validity of close transaction is the minimum between <code>maxGraceTime</code>
and <code>contestationPeriod</code> and this needs to be <em>good enough</em> value with respect
to running network. This is a consequence required by the ledger when
constructing transactions since we cannot convert arbitrary point in times to
slots.</p></li><li><p>All parties need to aggree on contestation period before trying to run a Head
protocol otherwise InitTx will be ignored.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/22">22. Test High-level Properties using Model-Based Testing
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li>We have been experimenting with <a href="https://hackage.org/packages/quickcheck-dynamic" target="_blank" rel="noopener noreferrer">quickcheck-dynamic</a> for a while, leading to the implementation of basic <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/ModelSpec.hs" target="_blank" rel="noopener noreferrer">Model-Based tests</a> for the Hydra Head Protocol</li><li>These tests fill a gap in our testing strategy, between <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/BehaviorSpec.hs" target="_blank" rel="noopener noreferrer">BehaviorSpec</a> tests which test a &quot;network&quot; of nodes but only at the level of the off-chain Head logic, and <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-cluster/test/Test/EndToEndSpec.hs" target="_blank" rel="noopener noreferrer">EndToEndSpec</a> tests which test a full blown network of nodes interconnected through real network connections and to a real cardano-node:<ul><li>The former are fast but do not test the complete lifecycle of a Head. Furthermore, they are only unit tests so do not provide coverage into various corner cases that could arise in practice</li><li>The latter exercise the full lifecycle but are very slow and brittle</li></ul></li><li>Because they run in <a href="https://github.com/input-output-hk/io-sim" target="_blank" rel="noopener noreferrer">io-sim</a>, those Model-based tests are fast and robust as they don&#x27;t depend on system interactions. Moreover, decoupling the <em>System-under-Test</em> from <code>IO</code> makes it easy to simulate an environment that deviates from the &quot;happy path&quot; such as delays from the network, filesystem errors, or even adversarial behaviour from the node, or the chain.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We will maintain and evolve the <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/Model.hs" target="_blank" rel="noopener noreferrer">Model</a> over time to cover more features</li><li>Key properties of the whole system should be written-down as proper <code>DynamicLogic</code> properties and thoroughly tested using quickcheck-dynamic. This includes but is not limited to:<ul><li>Liveness of the Head</li><li>Consistency of the Head</li><li>Soundness of Chain</li><li>Completeness of Chain</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>We need to ensure the Model covers the full lifecycle of a Hydra Head network which at the time of writing this ADR is not the case</li><li>There cannot be <em>One Model to Rule Them All</em> so we should refrain from defining different <code>StateModel</code> or different <code>RunModel</code> depending on what needs to be tested</li><li>In particular, testing against adversarial conditions will certainly require defining different instances of the <code>Network</code> or <code>Chain</code> components, for example:<ul><li>An <em>Active Adversary</em> that fully the controls the protocol and the parties,</li><li>A <em>Network Adversary</em> that can delay and or drop messages,</li><li>A <em>Faulty Filesystem</em> that can causes exceptions when reading or writing files,</li><li>...</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/23">23. Local chain state in chain layer
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-26T00:00:00.000Z" itemprop="datePublished">April 26, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><a href="/head-protocol/unstable/adr/18">ADR 18</a> merged both <code>headState</code> and <code>chainState</code> into one single
state in the Hydra node, giving the chain layer a way to <em>fetch</em> and update
the <code>chainState</code> when observing a chain event.</li><li>Having the <code>headState</code> containing the <code>chainState</code> made persistency easier to
deal with: we ensure that we always save cohesive states.</li><li>When opening our first head on mainnet we suffered from a <a href="https://github.com/input-output-hk/hydra/issues/784" target="_blank" rel="noopener noreferrer">commit/rollback
issue</a> that was the
result of a race condition in the management of the <code>chainState</code> as implemented
in the context of <a href="/head-protocol/unstable/adr/18">ADR 18</a>.</li><li>Reproducing the issue by introducing rollbacks in the model based tests, we
discovered that, as a client of a hydra-node, we had no idea how to deal with
the rollback event as it is defined now.</li><li><a href="https://github.com/input-output-hk/hydra/issues/185" target="_blank" rel="noopener noreferrer">#185</a> plans to improve
rollback management.</li></ul><p>The following picture details the race condition through an exemple:</p><ol><li><p>The DirectChain component fetch some <code>chainState 0</code> from the <code>headState</code></p></li><li><p>The DirectChain component observes a transaction and it</p></li></ol><ul><li>publishes an event about this observation</li><li>updates the <code>headState</code> with some <code>chainState 1</code></li></ul><ol><li>The Node processes the event and emits a new <code>headState</code> with a
<code>previousRecoverableState</code> in case a rollback later happens</li></ol><p>The problem is that <code>HeadState 2</code> in the figure should point to a previous
recoverable head state containing <code>chainState 0</code> and not <code>chainState 1</code>.</p><p><img loading="lazy" alt="race condition" src="/head-protocol/unstable/assets/images/2023-04-26-023-race-condition-7bc6b62f01470cdeaaaf81ec5227363e.jpg" width="2310" height="1731" class="img_ev3q"></p><p>Updating the chain state only in the <code>HeadLogic</code> leads to problems when several
transactions are in the same block. This can be mitigated by keeping a volatile
chain state locally while analysing the block. But then it leads to race
conditions issues if, for some reason, blocks are produced faster than they are
processed by the HeadLogic. Low probability in production but higher when
testing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We supersede <a href="/head-protocol/unstable/adr/18">ADR 18</a> with the current ADR.</li><li>A local chain state is re-introduced in the chain component, not shared with
the head logic.</li><li>A copy of the <code>chainState</code> is kept in the <code>headState</code> to keep the benefits of
<a href="/head-protocol/unstable/adr/18">ADR 18</a> regarding persistency.</li><li>The <code>RolledBack</code> output is removed from the API unless actionable by users or
<a href="https://github.com/input-output-hk/hydra/issues/185" target="_blank" rel="noopener noreferrer">#185</a> implemented.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>The rollback logic is removed from the HeadLogic and only maintained in the
chain component.</li><li>The Rollback event carries the ChainState.</li><li>At the node startup, we initialize the chain layer with the persisted
<code>chainState</code></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/24">24. Persist state changes incrementally
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li>The state of a Hydra Head is currently persisted as a whole upon each <code>NewState</code> <em>outcome</em> from the <code>update</code> function: The new state is serialised and the <code>state</code> file is overwritten with the corresponding bytes. While this is a straightforward strategy to implement, it has a huge impact on the performance of a Hydra Head as serialising a large data structure like the <code>HeadState</code> and completely overwriting a file is costly<ul><li>We revisited our benchmarks and <a href="https://github.com/input-output-hk/hydra/issues/186#issuecomment-1584292265" target="_blank" rel="noopener noreferrer">found</a> that persistence was the major bottleneck when measuring roundtrip confirmation time,e g. the time it takes from a client&#x27;s perspective to submit a transaction and observe in a <code>ConfirmedSnapshot</code></li></ul></li><li>Furthermore, the way we currently handle changes to the <code>HeadState</code> in the hydra-node, while conceptually being an <code>Effect</code> is handled differently from other <code>Effect</code>s: The state is updated transactionally through a dedicated <code>modifyHeadState</code> function in the core loop of processing events, and <em>then</em> effects are processed.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><p>Implement state persistence using <a href="https://thinkbeforecoding.com/post/2013/07/28/Event-Sourcing-vs-Command-Sourcing" target="_blank" rel="noopener noreferrer"><em>Event Sourcing</em></a>. Practically, this means:</p><ol><li>Replace the <code>NewState</code> outcome with a <code>StateChanged</code> <em>event</em> which can be part of the <code>Outcome</code> of <code>HeadLogic</code>&#x27;s <code>update</code> function, representing the <em>change</em> to be applied to the current state.</li><li>Add an <code>aggregate</code> function to manage applying <code>StateChanged</code> events on top of the current <code>HeadState</code> to keep it updated in-memory.</li><li>Persist <code>StateChanged</code>s in an append-only log using a dedicated <a href="/head-protocol/unstable/adr/4">handle</a>.</li><li>Upon node startup, reread <code>StateChanged</code> events log and reapply those to reset the <code>HeadState</code>.</li></ol><p>The following sequence diagram illustrates new event handling in the <code>HeadLogic</code>:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li><p>🐎 The main expected consequence of this change is an increase of the overall performance of Hydra Head network.</p></li><li><p>Need to pattern match twice on the <code>HeadState</code>, once in <code>update</code> and once in <code>aggregate</code>.</p></li><li><p>Terms from the specification are distributed over <code>update</code> and <code>aggregate</code> function. For example, the statements about updating all seen transactions would now be in <code>aggregate</code> and not anymore in <code>update</code>.</p></li><li><p>New possibilities this change introduces with respect to <code>ServerOutput</code> handling and client&#x27;s access to a head&#x27;s state:</p><ul><li>Instead of having the <code>HeadLogic</code> emits directly a <code>ClientEffect</code>, the latter could be the result of a client-centric <em>interpretation</em> of a <code>StateChanged</code>.</li><li>Pushing this a little further, we could maintain a <em>Query Model</em> for clients with a dedicated <a href="https://github.com/input-output-hk/hydra/discussions/686" target="_blank" rel="noopener noreferrer">Query API</a> to ease implementation of stateless clients.</li></ul></li><li><p>Calling <code>StateChanged</code> an <em>event</em> while treating it in the code alongside <em>effects</em> might introduce some confusion as we already use the word <a href="https://github.com/input-output-hk/hydra/blob/45913954eb18ef550a31017daa443cee6720a00c/hydra-node/src/Hydra/HeadLogic.hs#L64" target="_blank" rel="noopener noreferrer">Event</a> to designate the inputs (a.k.a. commands) to the Head logic state machine. We might want at some later point to unify the terminology.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/25">25. Event-sourced, resource-based API
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-18T00:00:00.000Z" itemprop="datePublished">August 18, 2023</time> · <!-- -->5 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Draft</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><p><a href="/head-protocol/unstable/adr/3">ADR-3</a> concluded that a full-duplex communication channels are
desirable to interact with a <em>reactive</em> system.</p></li><li><p>The Client API communicates several types of messages to clients. Currently
this ranges from node-level <code>PeerConnected</code>, over head-specific <code>HeadIsOpen</code>
to messages about transactions like <code>TxValid</code>. These messages are all of type
<code>StateChanged</code>.</p></li><li><p>Current capabilities of the API:</p><ul><li><p>Clients can retrieve the whole history of <code>StateChanged</code> messages or
opt-out using a query parameter - all or nothing.</p></li><li><p>There is a welcome message called <code>Greetings</code> which is always sent, that
contains the last <code>headStatus</code>.</p></li><li><p>There exists a <code>GetUTxO</code> query-like <code>ClientInput</code>, which will respond with a
<code>GetUTxOResponse</code> containing the confirmed UTxO set in an open head, or (!)
the currently committed UTxO set when the head is initializing.</p></li><li><p>While overall <code>json</code> encoded, clients can choose choose between <code>json</code> or
binary (<code>cbor</code>) output of <code>transaction</code> fields in several of these using a
query parameter.</p></li></ul></li><li><p>Many of these features have been added in a &quot;quick and dirty&quot; way, by monkey
patching the encoded JSON.</p></li><li><p>The current capabalities even do not satisfy all user needs:</p><ul><li><p>Need to wade through lots of events to know the latest state (except the
very basic <code>headStatus</code> from the <code>Greetings</code>).</p></li><li><p>Need to poll <code>GetUTxO</code> <em>or</em> aggregate confirmed transactions on client side
to know the latest UTxO set for constructing transactions.</p></li><li><p>Inclusion of the whole UTxO set in the head is not always desirable and
filtering by address would be beneficial. (not addressed in this ADR though,
relevant discussion
<a href="https://github.com/input-output-hk/hydra/discussions/797" target="_blank" rel="noopener noreferrer">#797</a>)</p></li><li><p>As <a href="/head-protocol/unstable/adr/15">ADR-15</a> also proposes, some clients may not need (or should
not have) access to administrative information.</p></li></ul></li><li><p>It is often a good idea to separate the responsibilities of Commands and
Queries (<a href="https://martinfowler.com/bliki/CQRS.html" target="_blank" rel="noopener noreferrer">CQRS</a>), as well as the model they use.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li><p>Drop <code>GetUTxO</code> and <code>GetUTxOResponse</code> messages as they advocate a
request/response way of querying.</p></li><li><p>Realize that <code>ClientInput</code> data is actually a <code>ClientCommand</code> (renaming them)
and that <code>ServerOutput</code> are just <code>projections</code> of the <a href="/head-protocol/unstable/adr/24">internal event stream
(see ADR-24)</a> into read <code>models</code> on the API layer.</p></li><li><p>Compose a versioned (<code>/v1</code>) API out of resource <code>models</code>, which
compartmentalize the domain into topics on the API layer.</p><ul><li><p>A resource has a <code>model</code> type and the <em>latest</em> value is the result of a pure
<code>projection</code> folded over the <code>StateChanged</code> event stream, i.e. <code>project :: model -&gt; StateChanged -&gt; model</code>.</p></li><li><p>Each resource is available at some HTTP path, also called &quot;endpoint&quot;:</p><ul><li><p><code>GET</code> requests must respond with the <em>latest</em> state in a single response.</p></li><li><p><code>GET</code> requests with <code>Upgrade: websocket</code> headers must start a websocket
connection, push the <em>latest</em> state as first message and any resource
state updates after.</p></li><li><p>Other HTTP verbs may be accepted by a resource handler, i.e. to issue
resource-specific <em>commands</em>. Any commands accepted must also be available
via the corresponding websocket connection.</p></li></ul></li><li><p><code>Accept</code> request headers can be used to configure the <code>Content-Type</code> of the
response</p><ul><li><p>All resources must provide <code>application/json</code> responses</p></li><li><p>Some resources might support more content types (e.g. CBOR-encoded binary)</p></li></ul></li><li><p>Query parameters may be used to further configure responses of some
resources. For example, <code>?address=&lt;bech32&gt;</code> could be used to filter UTxO by
some address.</p></li></ul></li><li><p>Keep the semantics of <code>/</code>, which accepts websocket upgrade connections and
sends direct/raw output of <code>ServerOutput</code> events on <code>/</code>, while accepting all
<code>ClientCommand</code> messages.</p><ul><li>Define <code>ServerOutput</code> also in terms of the <code>StateChanged</code> event stream</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-resources">Example resources<a href="#example-resources" class="hash-link" aria-label="Direct link to Example resources" title="Direct link to Example resources">​</a></h3><p>Example resource paths + HTTP verbs mapped to existing things to demonstrate the
effects of the decision points above. The mappings may change and are to be
documented by an API specification instead.</p><table><thead><tr><th align="left">Path</th><th align="left">GET</th><th align="left">POST</th><th>PATCH</th><th align="left">DELETE</th></tr></thead><tbody><tr><td align="left"><code>/v1/head/status</code></td><td align="left"><code>HeadStatus(..)</code></td><td align="left">-</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head/snapshot/utxo</code></td><td align="left">last confirmed snapshot utxo</td><td align="left">-</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head/snapshot/transactions</code></td><td align="left">confirmed snapshot txs</td><td align="left"><code>NewTx</code> + responses</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head/ledger/utxo</code></td><td align="left"><code>localUTxO</code></td><td align="left">-</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head/ledger/transactions</code></td><td align="left"><code>localTxs</code></td><td align="left"><code>NewTx</code> + responses</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head/commit</code></td><td align="left">-</td><td align="left"><code>Chain{draftCommitTx}</code></td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/head</code></td><td align="left">all <code>/v1/head/*</code> data</td><td align="left"><code>Init</code></td><td><code>Close</code></td><td align="left"><code>Fanout</code> / <code>Abort</code></td></tr><tr><td align="left"><code>/v1/protocol-parameters</code></td><td align="left">current protocol parameters</td><td align="left"></td><td></td><td align="left"></td></tr><tr><td align="left"><code>/v1/cardano-transaction</code></td><td align="left">-</td><td align="left"><code>Chain{submitTx}</code></td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/peers</code></td><td align="left">a list of peers</td><td align="left">-</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/node-version</code></td><td align="left">node version as in <code>Greetings</code></td><td align="left">-</td><td>-</td><td align="left">-</td></tr><tr><td align="left"><code>/v1/</code></td><td align="left">all <code>/v1/*</code> data</td><td align="left">-</td><td>-</td><td align="left">-</td></tr></tbody></table><p>Multiple heads are out of scope now and hence paths are not including a
<code>&lt;headId&gt;</code> variable section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li><p>Clear separation of what types are used for querying and gets subscribed to by
clients and we have dedicated types for sending data to clients</p></li><li><p>Changes on the querying side of the API are separated from the business logic.</p></li><li><p>Clients do not need to aggregate data that is already available on the server
side without coupling the API to internal state representation.</p></li><li><p>Separation of Head operation and Head usage, e.g. some HTTP endpoints can be
operated with authentication.</p></li><li><p>Clients have a fine-grained control over what to subscribe to and what to
query.</p></li><li><p>Versioned API allows clients to detect incompatibility easily.</p></li><li><p>Need to rewrite how the <code>hydra-tui</code> is implemented.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/draft">Draft</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/27">27. Network failures model
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-08T00:00:00.000Z" itemprop="datePublished">September 8, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pgrange.png" alt="Pascal Grange"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Pascal Grange</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Draft</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>The current Head cluster is very fragile as has been observed on several occasions: A single hiccup in the connectivity between nodes while a head is open and nodes are exchanging messages can very easily lead to the Head being stuck and require an emergency closing, possibly even manually.</p><p>We want Hydra to be <em>Consistent</em> in the presence of <em>Network Partitions</em>, under the <em>fail-recovery</em> model assumption, eg. processes may fail by stopping and later recovering. Our system lies in the <a href="https://en.wikipedia.org/wiki/CAP_theorem" target="_blank" rel="noopener noreferrer">CP</a> space of the landscape mapped by the CAP theorem.</p><p>We have identified 3 main sources of failures in the <em>fail-recovery</em> model that can lead to a head being stuck:</p><ol><li>The network layer can drop messages from the moment a node <code>broadcast</code>s it, leading to some messages not being received at the other end</li><li>The sending node can crash in between the moment the state is changed (and persisted) and the moment a message is actually sent through the network (or even when it calls <code>broadcast</code>)</li><li>The receiving node can crash in between the moment the message has been received in the network layer, and it&#x27;s processed (goes through the queue)</li></ol><p>We agree that we&#x27;ll want to address all those issues in order to provide a good user experience, as not addressing 2. and 3. can lead to hard to troubleshoot issues with heads. We have not experienced those issues yet as they would probably only crop up under heavy loads, or in the wild. But we also agree we want to tackle 1. first because it&#x27;s where most of the risk lies. By providing a <em>Reliable Broadcast</em> layer, we will significantly reduce the risks and can then later on address the other points.</p><p>Therefore, the scope of this ADR is to address only point 1. above: Ensure broadcast messages are eventually received by all peers, given the sender does not stop before.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="Direct link to Discussion" title="Direct link to Discussion">​</a></h3><ul><li><p>We are currently using the <a href="https://github.com/input-output-hk/ouroboros-network" target="_blank" rel="noopener noreferrer">ouroboros-framework</a> and <a href="https://github.com/input-output-hk/typed-protocols" target="_blank" rel="noopener noreferrer">typed-protocols</a> network stack as a mere <a href="https://osi-model.com/transport-layer/" target="_blank" rel="noopener noreferrer">transport</a> layer.</p><ul><li>Being built on top of TCP, ouroboros multiplexer (Mux) provides the same reliability guarantees, plus the multiplexing capabilities of course</li><li>It also takes care of reconnecting to peers when a failure is detected which relieves us from doing so, but any reconnection implies a reset of each peer&#x27;s state machine which means we need to make sure any change to the state of pending/received messages is handled by the applicative layer</li><li>Our <a href="https://github.com/input-output-hk/hydra/blob/8a8e0829964132bde8949e5249a1ab303af92fb8/hydra-node/src/Hydra/Network/Ouroboros/Type.hs#L31" target="_blank" rel="noopener noreferrer">FireForget protocol</a> ignores connections/disconnections</li><li>Ouroboros/typed-protocols provides enough machinery to implement a reliable broadcast protocol, for example by reusing existing <code>[KeepAlive](https://github.com/input-output-hk/ouroboros-network/tree/master/ouroboros-network-protocols/src/Ouroboros/Network/Protocol/KeepAlive)</code> protocol and building a more robust point-to-point protocol than what we have now</li><li>There is a minor limitation, namely that the subscription mechanism does not handle connections invidually, but as a set of equivalent point-to-point full duplex connections whose size (valency) needs to be maintained at a certain threshold, which means that unless backed in the protocol itself, protocol state-machine and applications are not aware of the identity of the remote peer</li></ul></li><li><p>We have built our <code>Network</code> infrastructure over the concept of relatively independent layers, each implementing a similar interface with different kind of messages, to <code>broadcast</code> messages to all peers and be notified of incoming messages through a <code>callback</code>.</p><ul><li><p>This pipes-like abstraction allows us to compose our network stack like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> withAuthentication (contramap Authentication tracer) signingKey otherParties $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  withHeartbeat nodeId connectionMessages $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withOuroborosNetwork (contramap Network tracer) localhost peers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>This has the nice property that we can basically swap the lower layers should we need to, for example to use <a href="https://github.com/input-output-hk/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/UDP.hs" target="_blank" rel="noopener noreferrer">UDP</a>, or add other layers for example to address specific head instances in presence of <a href="https://github.com/input-output-hk/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/MultiHead.hs#L26" target="_blank" rel="noopener noreferrer">multiple heads</a></p></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We implement our own message tracking and resending logic as a standalone <code>Network</code> layer</li><li>That layer consumes and produces <code>Authenticated msg</code> messages as it relies on identifying the source of messages</li><li>It uses a vector of monotonically increasing <em>sequence numbers</em> associated with each party (including itself) to track what are the last messages from each party and to ensure FIFO delivery of messages<ul><li>This <em>vector</em> is used to identify peers which are lagging behind, resend the missing messages, or to drop messages which have already been received</li><li>The <em>Heartbeat</em> mechanism is relied upon to ensure dissemination of state even when the node is quiescent</li></ul></li><li>We do not implement a <em>pull-based</em> message communication mechanism as initially envisioned</li><li>We do not persist messages either on the receiving or sending side at this time</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>We keep our existing <code>Network</code> interface hence all messages will be resent to all peers<ul><li>This could be later optimized either by providing a smarter interface with a <code>send :: Peer -&gt; msg -&gt; m ()</code> unicast function, or by adding a layer with filtering capabilities, or both</li></ul></li><li>We want to specify this protocol clearly in order to ease implementation in other languages, detailing the structure of messages and the semantics of retries and timeouts.</li><li>We may consider relying on the vector clock in the future to ensure perfect ordering of messages on each peer and make impossible for legit transactions to be temporarily seen as invalid. This can happen in the current version and is handled through wait and <em>TTL</em></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/proposed">Proposed</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/adr/26">26. Stateless transaction observaion &amp; construction
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-08T00:00:00.000Z" itemprop="datePublished">September 8, 2023</time> · <!-- -->4 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Draft</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><p><a href="/head-protocol/unstable/adr/18">ADR 18</a> merged both <code>headState</code> and <code>chainState</code> into one single
state in the Hydra node, giving the chain layer a way to <em>fetch</em> and update
the <code>chainState</code> when observing a chain event.</p></li><li><p><a href="/head-protocol/unstable/adr/23">ADR 23</a> outlined the need for a local chain state in the chain layer
again to correctly handle correct observation of multiple relevant
transactions and the resulting <code>chainState</code> updates.</p></li><li><p>The <code>ChainStateType tx</code> for our &quot;actual&quot; Cardano chain layer is currently:</p><div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ChainStateAt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ChainStateAt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token hvariable">chainState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ChainState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">recordedAt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ChainPoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ChainState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Idle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Initial</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">InitialState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Open</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">OpenState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Closed</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ClosedState</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where <code>InitialState</code>, <code>OpenState</code> and <code>ClosedState</code> hold elaborate information
about the currently tracked Hydra head.</p></li><li><p>We face <a href="https://github.com/input-output-hk/hydra/issues/529" target="_blank" rel="noopener noreferrer">difficulties</a> to
provide sufficient user feedback when an <code>initTx</code> was observed but (for
example) keys do not match our expectation.</p><ul><li>Core problem is, that <code>observeInit</code> is required to take a decision whether
it wants to &quot;adopt&quot; the Head by returning an <code>InitialState</code> or not.</li><li>This makes it impossible to provide user feedback through the <code>HeadLogic</code>
and <code>API</code> layers.</li></ul></li><li><p>We want to build a <a href="https://github.com/input-output-hk/hydra/issues/696" target="_blank" rel="noopener noreferrer">Hydra head
explorer</a>, which should
be able to keep track and discover Hydra heads and their state changes even
when the heads were initialized before starting the explorer.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We supersede <a href="/head-protocol/unstable/adr/18">ADR 18</a> with the current ADR.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="changes-internal-to-direct-chain-layer">Changes internal to Direct chain layer<a href="#changes-internal-to-direct-chain-layer" class="hash-link" aria-label="Direct link to Changes internal to Direct chain layer" title="Direct link to Changes internal to Direct chain layer">​</a></h3><ul><li><p>Introduce a <code>ResolvedTx</code> type that has its inputs resolved. Where a normal
<code>Tx</code> will only contain <code>TxIn</code> information of its inputs, a <code>ResolvedTx</code> also
includes the <code>TxOut</code> for each input.</p></li><li><p>Change <code>ChainSyncHandler</code> signature to <code>onRollForward :: BlockHeader -&gt; [ResolvedTx] -&gt; m ()</code></p></li><li><p>Change observing function signature to <code>observeSomeTx :: ChainContext -&gt;
ResolvedTx -&gt; Maybe (OnChainTx Tx)</code>. Notably there is no <code>ChainState</code>
involved.</p></li><li><p>Do not guard observation by <code>HeadId</code> in the chain layer and instead do it in the <code>HeadLogic</code> layer.</p></li><li><p>Define a <code>SpendableUTxO</code> type that is a <code>UTxO</code> with potentially needed datums included.</p><ul><li>TBD: instead we could decide to use inline datums and rely on <code>UTxO</code> containing them</li></ul></li><li><p>Change transaction creation functions <code>initialize</code>, <code>commit</code>, <code>abort</code>,
<code>collect</code>, <code>close</code>, <code>contest</code> and <code>fanout</code> in <code>Hydra.Direct.Chain.State</code> to
take <code>SpendableUTxO</code> and <code>HeadId</code>/<code>HeadParameters</code> as needed.</p></li><li><p>Extend <code>IsChainState</code> type class to enforce that it can be updated by
concurrent transactions <code>update :: ChainStateType tx -&gt; [tx] -&gt; ChainStateType tx</code>.</p><ul><li>While this is not strictly needed &quot;outside&quot; of the chain layer, it will have
us not fall into the same pit again.</li></ul></li><li><p>Change <code>ChainStateAt</code> to only hold a <code>spendableUTxO</code> and the <code>recordedAt</code>.</p></li><li><p>Update the <code>LocalChainState</code> in <code>onRollForward</code> by using <code>update</code> and pushing
a new <code>ChainStateAt</code> generically.</p></li></ul><p>TBD:</p><ul><li>Impact on generators</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="chain-interface-changes">Chain interface changes<a href="#chain-interface-changes" class="hash-link" aria-label="Direct link to Chain interface changes" title="Direct link to Chain interface changes">​</a></h3><ul><li><p>Add <code>HeadId</code> and <code>HeadParameters</code> to <code>PostChainTx</code>.</p></li><li><p>Add <code>HeadId</code> to all <code>OnChainTx</code> constructors.</p></li><li><p>Extend <code>OnInitTx</code> with observed chain participants.</p><ul><li>TBD: How are <em>cardano</em> verification keys generically represented in <code>HeadLogic</code>?</li></ul></li><li><p>Extend <code>OnContestTx</code> with new deadline and a list of contesters.</p></li><li><p>Move off-chain checks for what makes a &quot;proper head&quot; to <code>HeadLogic</code></p></li></ul><p>TBD:</p><ul><li>Merge <code>HeadSeed</code> and <code>HeadId</code>? How to abstract?</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li><p>All logic is kept in the logic layer and no protocol decisions (i.e. whether
to adopt or ignore a head initialization) are taken in the chain layer.</p><ul><li>The <code>HeadLogic</code> gets informed of any proper <code>initTx</code> and can log that it is
ignored and for what reason.</li></ul></li><li><p>The transaction observation and construction functions can be moved into a
dedicated package that is cardano-specific, but not requires special state
knowledge of the &quot;direct chain following&quot; and can be re-used as a library.</p></li><li><p>All transaction observation functions used by <code>observeSomeTx</code> will need to be
able to identify a Hydra Head transaction from only the <code>ResolvedTx</code> and the
<code>ChainContext</code></p></li><li><p>Any <code>Chain Tx</code> implementation wanting to re-use existing transaction
observation functions must be able to resolve transaction inputs (against some
ledger state) and produce <code>ResolvedTx</code>.</p><ul><li>A chain-following implementation (as <code>Hydra.Chain.Direct</code>) can keep previous
transactions around.</li><li>A chain indexer on &quot;interesting&quot; protocol addresses can be used to
efficiently query most inputs.</li></ul></li><li><p>We can get rid of the <code>Hydra.Chain.Direct.State</code> glue code altogether.</p></li><li><p>While this does not directly supersede <a href="/head-protocol/unstable/adr/23">ADR23</a>, it paves the way to
remove <code>LocalChainState</code> again as the <code>ChainStateAt</code> is now combinable from
multiple transactions (see <code>update</code> above) and we can keep the state (again)
only in the <code>HeadState</code> aggregate. Note that this would shift the rollback
handling back into the logic layer.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/adr/tags/draft">Draft</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/head-protocol/unstable/adr/page/2"><div class="pagination-nav__label">Newer Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Coding-Standards" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding Standards</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/adr">Architectural Decision Records</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Testing Strategy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord (#ask-hydra)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cardano.stackexchange.com/questions/tagged/hydra" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Exchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/docs/haskell_packages">Haskell Packages</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/monthly">Monthly reports</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Logbook" target="_blank" rel="noopener noreferrer" class="footer__link-item">Logbook</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://static.iohk.io/terms/iohktermsandconditions.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms &amp; Conditions</a></li><li class="footer__item"><a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/graphs/contributors" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributors</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          <small>
          Built with Docusaurus on 2023-09-05T18:35:51+02:00
          </small>
          </div></div></div></footer></div>
<script src="/head-protocol/unstable/assets/js/runtime~main.9aa57279.js"></script>
<script src="/head-protocol/unstable/assets/js/main.c6fe520e.js"></script>
</body>
</html>