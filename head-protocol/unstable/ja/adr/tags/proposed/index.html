<!doctype html>
<html lang="ja" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">「Proposed」タグの記事が2件あります | Hydra: Head Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://input-output-hk.github.io/head-protocol/unstable/ja/adr/tags/proposed"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" property="og:title" content="「Proposed」タグの記事が2件あります | Hydra: Head Protocol"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/head-protocol/unstable/ja/img/hydra.png"><link data-rh="true" rel="canonical" href="https://input-output-hk.github.io/head-protocol/unstable/ja/adr/tags/proposed"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/adr/tags/proposed" hreflang="en"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/fr/adr/tags/proposed" hreflang="fr"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/ja/adr/tags/proposed" hreflang="ja"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/es/adr/tags/proposed" hreflang="es"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/unstable/adr/tags/proposed" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YZTAF8IOVB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/head-protocol/unstable/ja/adr/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/unstable/ja/adr/atom.xml" title="Hydra: Head Protocol Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Hydra: Head Protocol" href="/head-protocol/unstable/ja/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/head-protocol/unstable/ja/monthly/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/unstable/ja/monthly/atom.xml" title="Hydra: Head Protocol Atom Feed">







<script src="https://plausible.io/js/script.js" defer="defer" data-domain="hydra.family"></script><link rel="stylesheet" href="/head-protocol/unstable/ja/assets/css/styles.e2304069.css">
<link rel="preload" href="/head-protocol/unstable/ja/assets/js/runtime~main.055f7ea5.js" as="script">
<link rel="preload" href="/head-protocol/unstable/ja/assets/js/main.2b8c094f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/head-protocol/unstable/ja/"><div class="navbar__logo"><img src="/head-protocol/unstable/ja/img/hydra.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--light_HNdA"><img src="/head-protocol/unstable/ja/img/hydra-white.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Hydra: Head Protocol</b></a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/docs/getting-started">ユーザーズマニュアル</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/api-reference">APIリファレンス</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/core-concepts">コアコンセプト</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/benchmarks">ベンチマーク</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/topologies">トポロジー</a><a class="navbar__item navbar__link" href="/head-protocol/unstable/ja/use-cases">Use Cases</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/input-output-hk/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/head-protocol/unstable/adr/tags/proposed" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/head-protocol/unstable/fr/adr/tags/proposed" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Français</a></li><li><a href="/head-protocol/unstable/ja/adr/tags/proposed" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li><li><a href="/head-protocol/unstable/es/adr/tags/proposed" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="es">Español</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently ライトモード)" aria-label="Switch between dark and light mode (currently ライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="検索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">検索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Architectural Decision Records</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/1">1. Record Architecture Decisions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/2">2. Reactive Core
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/3">3. Asynchronous Duplex Client API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/4">4. Use Handle to model Effects
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/5">5. Use io-classes
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/6">6. Network Broadcasts all messages
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/7">7. Use with-pattern based component interfaces
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/8">8. Custom Prelude
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/9">9. Simplify Logging
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/10">10. Use Direct Connection to `cardano-node`
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/11">11. Use cardano-api
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/12">12. Top-down Test-driven Design
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/13">13. Plutus Contracts Testing Strategy
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/14">14. Token usage in Hydra Scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/15">15. Configuration Through an Admin API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/16">16. Keep Rejected ADRs
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/17">17. Use UDP protocol for Hydra networking
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/18">18. Single state in Hydra.Node.
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/19">19. Use of reference scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/20">20. Handling time
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/22">22. Test High-level Properties using Model-Based Testing
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/23">23. Local chain state in chain layer
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/24">24. Persist state changes incrementally
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/25">25. Event-sourced, resource-based API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/27">27. Network failures model
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/unstable/ja/adr/26">26. Stateless transaction observaion &amp; construction
</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>「Proposed」タグの記事が2件あります</h1><a href="/head-protocol/unstable/ja/adr/tags">全てのタグを見る</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/ja/adr/19">19. Use of reference scripts
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-22T00:00:00.000Z" itemprop="datePublished">2022年7月22日</time> · <!-- -->約4分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><p>Proposed</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><ul><li><p>In the desire to make Hydra transactions smaller and cheaper (at the time of writing any abort tx was too big), we want to use the <strong>reference script</strong> and <strong>reference input</strong> features of the upcoming <code>Babbage</code> ledger era. See the <a href="https://hydra.iohk.io/build/16861604/download/1/babbage-changes.pdf" target="_blank" rel="noopener noreferrer">babbage ledger spec</a>, <a href="https://github.com/cardano-foundation/CIPs/tree/master/CIP-0031" target="_blank" rel="noopener noreferrer">CIP-31</a> and <a href="https://github.com/cardano-foundation/CIPs/tree/master/CIP-0033" target="_blank" rel="noopener noreferrer">CIP-33</a> for details.</p></li><li><p>With these features we do not need to (re-)include scripts in each transaction.</p></li><li><p>The CIPs do not specify how reference scripts are to be managed and we can see at least two options:</p><ol><li>Add them as outputs to the <code>init</code> transaction or prior that as part of each Hydra Head instance</li><li>Post them out-of-band, separate to individual Head instances</li></ol></li><li><p>Ownership of the outputs holding the scripts is to be considered. If these &quot;reference outputs&quot; are spent, they cannot be referred to anymore. This would mean all heads referring to them can be denied of service (DoS).</p></li><li><p>Each head will need to refer to the correct version of the hydra scripts. That is, consistent with the script hashes known to the <code>hydra-node</code>.</p><ul><li>This is also related to the problem of managing script versions &amp; updates.</li><li>Right now, the <code>hydra-node</code> is compiled against <code>hydra-plutus</code> to access compiled script content and hashes.</li></ul></li><li><p>The general trade-off is: instead of paying ADA fees for scripts adding to the transaction size in <em>each</em> transaction, ADA deposits will need to be put down to have scripts be part of the UTxO set in the ledger <em>once</em>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><ul><li><p>Publish outputs holding Hydra scripts out-of-band (option 2), because</p><ul><li>All scripts would not fit into the <code>init</code> transaction directly, we would need to post multiple.</li><li>Costs (deposits) would need to be payed for each head instance.</li></ul></li><li><p>The scripts are stored at outputs addressed to some <strong>unspendable</strong> <code>v_publish</code> validator.</p><ul><li>This is to avoid DoS risk and unnecessariy centralization</li><li>We have considered &quot;garbage collection&quot; by allowing spending these outputs into re-publishing new versions of the script.<ul><li>This would make things even more complicated and we decided to not bother about &quot;littering the chain&quot; right now.</li></ul></li></ul></li><li><p>We will publish scripts on release of the <code>hydra-node</code>, or more specifically of the <code>hydra-plutus</code> package.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><ul><li><p>We need a process and/or tool to publish <code>hydra-plutus</code> scripts and need to pay the deposits.</p><ul><li>Any other party could do the same, this does not lead to centralization.</li></ul></li><li><p>The <code>hydra-node</code> would be need to know the <code>TxIn</code>s of the &quot;right&quot; published scripts.</p><ul><li>In the simplest case we would just make this configurable and provide configurations for the various networks after publishing scripts.</li></ul></li><li><p>If we combine the <code>v_publish</code> validator with a &quot;tag&quot;, this allows nodes to &quot;discover&quot; scripts of a known version </p><ul><li>For example, we could define <code>HydraHeadV1</code>, <code>HydraInitialV1</code> and <code>HydraCommitV1</code> as such tags</li><li>We could parameterize the validator by the tag, yielding unique addresses per tag.</li><li>Alternatively, the &quot;tag&quot; could be stored in a canonical form as datum on the script outputs. </li><li>In any case, this allows for some checking consistency or easier configuration (not needing to enumerate which <code>TxIn</code> is which script)</li></ul></li><li><p>By also knowing the script hashes the <code>hydra-node</code> can verify the integrity of &quot;found&quot; reference scripts</p><ul><li>This would be possible right now, as they are compiled into the node</li><li>Might be undesirable later for easier system configuration</li></ul></li><li><p>By making <code>v_publish</code> unspendable, we &quot;litter&quot; the chain. However, any garbage collection scheme would mean potential to DoS again.</p></li><li><p>Extended diagram for the <a target="_blank" href="/head-protocol/unstable/ja/assets/files/on-chain-abort-reference-scripts-4fdf2aae00b80ca995690fe6f3208f4e.jpg">abort</a> on-chain life-cycles of a Hydra Head to include reference scripts.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/ja/adr/tags/proposed">Proposed</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/unstable/ja/adr/27">27. Network failures model
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-08T00:00:00.000Z" itemprop="datePublished">2023年9月8日</time> · <!-- -->約5分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pgrange.png" alt="Pascal Grange"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Pascal Grange</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><p>Draft</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><p>The current Head cluster is very fragile as has been observed on several occasions: A single hiccup in the connectivity between nodes while a head is open and nodes are exchanging messages can very easily lead to the Head being stuck and require an emergency closing, possibly even manually.</p><p>We want Hydra to be <em>Consistent</em> in the presence of <em>Network Partitions</em>, under the <em>fail-recovery</em> model assumption, eg. processes may fail by stopping and later recovering. Our system lies in the <a href="https://en.wikipedia.org/wiki/CAP_theorem" target="_blank" rel="noopener noreferrer">CP</a> space of the landscape mapped by the CAP theorem.</p><p>We have identified 3 main sources of failures in the <em>fail-recovery</em> model that can lead to a head being stuck:</p><ol><li>The network layer can drop messages from the moment a node <code>broadcast</code>s it, leading to some messages not being received at the other end</li><li>The sending node can crash in between the moment the state is changed (and persisted) and the moment a message is actually sent through the network (or even when it calls <code>broadcast</code>)</li><li>The receiving node can crash in between the moment the message has been received in the network layer, and it&#x27;s processed (goes through the queue)</li></ol><p>We agree that we&#x27;ll want to address all those issues in order to provide a good user experience, as not addressing 2. and 3. can lead to hard to troubleshoot issues with heads. We have not experienced those issues yet as they would probably only crop up under heavy loads, or in the wild. But we also agree we want to tackle 1. first because it&#x27;s where most of the risk lies. By providing a <em>Reliable Broadcast</em> layer, we will significantly reduce the risks and can then later on address the other points.</p><p>Therefore, the scope of this ADR is to address only point 1. above: Ensure broadcast messages are eventually received by all peers, given the sender does not stop before.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h3><ul><li><p>We are currently using the <a href="https://github.com/input-output-hk/ouroboros-network" target="_blank" rel="noopener noreferrer">ouroboros-framework</a> and <a href="https://github.com/input-output-hk/typed-protocols" target="_blank" rel="noopener noreferrer">typed-protocols</a> network stack as a mere <a href="https://osi-model.com/transport-layer/" target="_blank" rel="noopener noreferrer">transport</a> layer.</p><ul><li>Being built on top of TCP, ouroboros multiplexer (Mux) provides the same reliability guarantees, plus the multiplexing capabilities of course</li><li>It also takes care of reconnecting to peers when a failure is detected which relieves us from doing so, but any reconnection implies a reset of each peer&#x27;s state machine which means we need to make sure any change to the state of pending/received messages is handled by the applicative layer</li><li>Our <a href="https://github.com/input-output-hk/hydra/blob/8a8e0829964132bde8949e5249a1ab303af92fb8/hydra-node/src/Hydra/Network/Ouroboros/Type.hs#L31" target="_blank" rel="noopener noreferrer">FireForget protocol</a> ignores connections/disconnections</li><li>Ouroboros/typed-protocols provides enough machinery to implement a reliable broadcast protocol, for example by reusing existing <code>[KeepAlive](https://github.com/input-output-hk/ouroboros-network/tree/master/ouroboros-network-protocols/src/Ouroboros/Network/Protocol/KeepAlive)</code> protocol and building a more robust point-to-point protocol than what we have now</li><li>There is a minor limitation, namely that the subscription mechanism does not handle connections invidually, but as a set of equivalent point-to-point full duplex connections whose size (valency) needs to be maintained at a certain threshold, which means that unless backed in the protocol itself, protocol state-machine and applications are not aware of the identity of the remote peer</li></ul></li><li><p>We have built our <code>Network</code> infrastructure over the concept of relatively independent layers, each implementing a similar interface with different kind of messages, to <code>broadcast</code> messages to all peers and be notified of incoming messages through a <code>callback</code>.</p><ul><li><p>This pipes-like abstraction allows us to compose our network stack like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> withAuthentication (contramap Authentication tracer) signingKey otherParties $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  withHeartbeat nodeId connectionMessages $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withOuroborosNetwork (contramap Network tracer) localhost peers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>This has the nice property that we can basically swap the lower layers should we need to, for example to use <a href="https://github.com/input-output-hk/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/UDP.hs" target="_blank" rel="noopener noreferrer">UDP</a>, or add other layers for example to address specific head instances in presence of <a href="https://github.com/input-output-hk/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/MultiHead.hs#L26" target="_blank" rel="noopener noreferrer">multiple heads</a></p></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><ul><li>We implement our own message tracking and resending logic as a standalone <code>Network</code> layer</li><li>That layer consumes and produces <code>Authenticated msg</code> messages as it relies on identifying the source of messages</li><li>It uses a vector of monotonically increasing <em>sequence numbers</em> associated with each party (including itself) to track what are the last messages from each party and to ensure FIFO delivery of messages<ul><li>This <em>vector</em> is used to identify peers which are lagging behind, resend the missing messages, or to drop messages which have already been received</li><li>The <em>Heartbeat</em> mechanism is relied upon to ensure dissemination of state even when the node is quiescent</li></ul></li><li>We do not implement a <em>pull-based</em> message communication mechanism as initially envisioned</li><li>We do not persist messages either on the receiving or sending side at this time</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="見出しへの直接リンク" title="見出しへの直接リンク">​</a></h2><ul><li>We keep our existing <code>Network</code> interface hence all messages will be resent to all peers<ul><li>This could be later optimized either by providing a smarter interface with a <code>send :: Peer -&gt; msg -&gt; m ()</code> unicast function, or by adding a layer with filtering capabilities, or both</li></ul></li><li>We want to specify this protocol clearly in order to ease implementation in other languages, detailing the structure of messages and the semantics of retries and timeouts.</li><li>We may consider relying on the vector clock in the future to ensure perfect ordering of messages on each peer and make impossible for legit transactions to be temporarily seen as invalid. This can happen in the current version and is handled through wait and <em>TTL</em></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/unstable/ja/adr/tags/proposed">Proposed</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="ブログ記事一覧のナビゲーション"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">貢献</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Coding-Standards" target="_blank" rel="noopener noreferrer" class="footer__link-item">コーディング規約</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/ja/adr">アーキテクチャデシジョンレコード</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer" class="footer__link-item">テスト戦略</a></li></ul></div><div class="col footer__col"><div class="footer__title">コミュニティ</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord (#ask-hydra)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Githubディスカッション<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cardano.stackexchange.com/questions/tagged/hydra" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Exchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">その他</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/ja/docs/haskell_packages">Haskellパッケージ</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/unstable/ja/monthly">Monthly reports</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Logbook" target="_blank" rel="noopener noreferrer" class="footer__link-item">Logbook</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://static.iohk.io/terms/iohktermsandconditions.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms &amp; Conditions</a></li><li class="footer__item"><a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/graphs/contributors" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributors</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 <strong>Input Output</strong> <br> <small>Built with Docusaurus</small></div></div></div></footer></div>
<script src="/head-protocol/unstable/ja/assets/js/runtime~main.055f7ea5.js"></script>
<script src="/head-protocol/unstable/ja/assets/js/main.2b8c094f.js"></script>
</body>
</html>